<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Planets & Biomes</title>
    <style>
        body {
            margin: 0;
            display: flex;
            font-family: sans-serif;
            background: #111;
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        #planetCanvas {
            flex: 1 1 auto;
            background-color: #000;
            display: block;
            width: 100%;
            height: 100vh;
        }

        #biomeList {
            width: 380px;
            height: 100vh;
            overflow-y: auto;
            background-color: #222;
            padding: 10px;
            box-sizing: border-box;
        }

        .biome {
            margin-bottom: 10px;
            cursor: pointer;
            opacity: 0.4;
            transition: opacity 0.2s, border 0.2s;
            border: 2px solid transparent;
            border-radius: 5px;
        }

        .biome img {
            width: 100%;
            border-radius: 5px;
            display: block;
            user-select: none;
        }

        .biome.selected {
            opacity: 1;
            border-color: #0ff;
        }
    </style>
</head>

<body>

    <canvas id="planetCanvas"></canvas>
    <div id="biomeList"></div>

    <script>
        const sidebarWidth = 380;
        const canvas = document.getElementById("planetCanvas");
        const ctx = canvas.getContext("2d");

        // Set canvas size to fill remaining width and full height
        function updateCanvasSize() {
            const width = window.innerWidth - sidebarWidth;
            const height = window.innerHeight;

            canvas.width = width;
            canvas.height = height;

            canvas.style.width = width + "px";
            canvas.style.height = height + "px";
        }

        updateCanvasSize();
        window.addEventListener('resize', () => {
            updateCanvasSize();
            drawPlanets();
        });

        let allPlanets = [];
        let selectedBiome = null; // null means show all planets

        let playablePlanetsSet = new Set();

        const backgroundImg = new Image();
        backgroundImg.src = 'images/sectors_upscaled_dimmed.png';
        backgroundImg.onload = () => {
            drawPlanets();
        };

        // Hover tracking
        let hoveredPlanet = null;
        const planetRadius = 8;

        // Cache for biome images
        const biomeImageCache = new Map();

        // Load biomes and preload images
        fetch('biomes.json')
            .then(res => res.json())
            .then(biomes => {
                const biomeList = document.getElementById("biomeList");

                // Preload default image for "all biomes"
                const defaultImg = new Image();
                defaultImg.src = "images/default.jpg";
                biomeImageCache.set("", defaultImg);

                // Default button to show all planets
                const defaultBtn = document.createElement("div");
                defaultBtn.className = "biome selected";
                defaultBtn.dataset.name = "";
                const defaultImgElem = document.createElement("img");
                defaultImgElem.src = "images/default.jpg";
                defaultImgElem.alt = "All Biomes";
                defaultImgElem.title = "Show All Planets";
                defaultBtn.appendChild(defaultImgElem);
                biomeList.appendChild(defaultBtn);

                defaultBtn.addEventListener("click", () => {
                    selectedBiome = null;
                    updateSelection(defaultBtn);
                    drawPlanets();
                });

                // Create biome buttons and preload images
                biomes.forEach(biome => {
                    const div = document.createElement("div");
                    div.className = "biome";
                    div.dataset.name = biome.name;

                    const img = new Image();
                    img.src = biome.image;
                    biomeImageCache.set(biome.name, img);

                    const imgElem = document.createElement("img");
                    imgElem.src = biome.image;
                    imgElem.alt = biome.name;
                    imgElem.title = biome.name;

                    div.appendChild(imgElem);
                    biomeList.appendChild(div);

                    div.addEventListener("click", () => {
                        selectedBiome = biome.name;
                        updateSelection(div);
                        drawPlanets();
                    });
                });

                function updateSelection(selectedDiv) {
                    document.querySelectorAll(".biome").forEach(el => {
                        el.classList.remove("selected");
                    });
                    selectedDiv.classList.add("selected");
                }
            });

        // Load planets and playable planets
        Promise.all([
            fetch('planets.json').then(res => res.json()),
            fetch('playable_planets.json').then(res => res.json())
        ]).then(([planets, playablePlanets]) => {
            allPlanets = planets;
            playablePlanetsSet = new Set(playablePlanets.map(p => p.planet.index));
            drawPlanets();
        });

        // Owner colors map
        const ownerColors = {
            "Humans": "cyan",
            "Automaton": "red",
            "Terminids": "yellow",
            "Illuminate": "purple"
        };

        // Mouse move to track hover planet
        canvas.addEventListener("mousemove", e => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            hoveredPlanet = null;

            for (const planet of allPlanets) {
                if (selectedBiome && planet.biome.name !== selectedBiome) continue;

                const x = (planet.position.x + 1) / 2 * canvas.width;
                const y = (1 - (planet.position.y + 1) / 2) * canvas.height;

                const dx = mouseX - x;
                const dy = mouseY - y;

                if (Math.sqrt(dx * dx + dy * dy) <= planetRadius) {
                    hoveredPlanet = planet;
                    break;
                }
            }

            drawPlanets();
        });

        function drawPlanets() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundImg, 0, 0, canvas.width, canvas.height);

            allPlanets
                .filter(planet => !selectedBiome || planet.biome.name === selectedBiome)
                .forEach(planet => {
                    const x = (planet.position.x + 1) / 2 * canvas.width;
                    const y = (1 - (planet.position.y + 1) / 2) * canvas.height;

                    ctx.beginPath();
                    ctx.arc(x, y, planetRadius, 0, Math.PI * 2);

                    const isPlayable = playablePlanetsSet.has(planet.index);
                    ctx.fillStyle = isPlayable
                        ? (ownerColors[planet.currentOwner] || "white")
                        : "grey";

                    ctx.fill();

                    // Set baseline & font explicitly for planet names
                    ctx.fillStyle = isPlayable ? "white" : "#777";
                    ctx.font = "12px Arial";
                    ctx.textBaseline = "alphabetic";  // << fix here
                    ctx.fillText(planet.name, x + 10, y + 4);
                });

            if (hoveredPlanet) {
                drawPopup(hoveredPlanet);
            }
        }

        function drawPopup(planet) {
            const x = (planet.position.x + 1) / 2 * canvas.width;
            const y = (1 - (planet.position.y + 1) / 2) * canvas.height;

            const padding = 10;
            const imgWidth = 140;
            const imgHeight = 60;

            const textHeight = 24;
            const boxWidth = imgWidth + padding * 2;
            const boxHeight = imgHeight + textHeight + padding * 2;
            const radius = 10;

            ctx.fillStyle = "rgba(0, 122, 204, 0.8)";
            roundRect(ctx, x + 15, y - boxHeight / 2, boxWidth, boxHeight, radius);
            ctx.fill();

            ctx.fillStyle = "white";
            ctx.font = "bold 16px Arial";
            ctx.textBaseline = "top";  // popup text baseline
            ctx.fillText(planet.biome.name, x + 15 + padding, y - boxHeight / 2 + padding);

            const img = biomeImageCache.get(planet.biome.name);
            if (img && img.complete) {
                ctx.drawImage(img, x + 15 + padding, y - boxHeight / 2 + padding + textHeight, imgWidth, imgHeight);
            }
        }


        // Helper function: draw rounded rect
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }
    </script>

</body>

</html>